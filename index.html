<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K12 SheerID 验证助手</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #f5f7fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      #app {
        display: flex;
        justify-content: center;
        padding-top: 20vh;
      }
      .container {
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .header h1 {
        color: #409eff;
        margin: 0;
        font-size: 26px;
        font-weight: 600;
      }
      .result-box {
        margin-top: 20px;
        padding: 15px;
        background: #f0f9eb;
        border-radius: 4px;
        border: 1px solid #e1f3d8;
      }
      .error-box {
        margin-top: 20px;
        padding: 15px;
        background: #fef0f0;
        border-radius: 4px;
        border: 1px solid #fde2e2;
      }
      .log-box {
        margin-top: 20px;
        background: #2b2b2b;
        color: #a9b7c6;
        padding: 15px;
        border-radius: 6px;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 13px;
        max-height: 250px;
        overflow-y: auto;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .log-entry {
        margin-bottom: 4px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <div class="header">
          <h1>K12 SheerID 验证助手</h1>
        </div>

        <el-form @submit.prevent="submitForm">
          <el-form-item label="SheerID 验证链接">
            <el-input
              v-model="inputVal"
              placeholder="请输入 SheerID 验证链接"
              clearable
              type="textarea"
              :rows="3"
              :disabled="loading"
            ></el-input>
          </el-form-item>

          <el-form-item>
            <el-button
              type="primary"
              @click="submitForm"
              :loading="loading"
              style="width: 100%; height: 48px; font-size: 16px"
            >
              {{ loading ? '正在验证中...' : '开始验证' }}
            </el-button>
          </el-form-item>
        </el-form>

        <div v-if="logs.length > 0" class="log-box" ref="logBoxRef">
          <div v-for="(log, index) in logs" :key="index" class="log-entry">
            {{ log }}
          </div>
        </div>

        <div v-if="result" class="result-box">
          <el-result
            icon="success"
            title="验证提交成功"
            :sub-title="result.message"
          >
            <template #extra>
              <p>
                <strong>Verification ID:</strong> {{ result.verification_id }}
              </p>
              <el-link
                v-if="result.redirect_url"
                :href="result.redirect_url"
                target="_blank"
                type="primary"
                >点击查看结果页面</el-link
              >
            </template>
          </el-result>
        </div>

        <div v-if="error" class="error-box">
          <el-result icon="error" title="验证失败" :sub-title="error">
          </el-result>
        </div>
      </div>
    </div>

    <!-- 引入 Vue 和 Element Plus -->
    <script src="//unpkg.com/vue@3"></script>
    <script src="//unpkg.com/element-plus"></script>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>

    <script>
      const { createApp, ref, onMounted, nextTick, watch } = Vue;

      const app = createApp({
        setup() {
          const inputVal = ref("");
          const loading = ref(false);
          const result = ref(null);
          const error = ref(null);
          const logs = ref([]);
          const logBoxRef = ref(null);
          let ws = null;

          // 初始化 WebSocket
          const initWebSocket = () => {
            const protocol =
              window.location.protocol === "https:" ? "wss:" : "ws:";
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/logs`);

            ws.onmessage = (event) => {
              logs.value.push(event.data);
              // 自动滚动到底部
              nextTick(() => {
                if (logBoxRef.value) {
                  logBoxRef.value.scrollTop = logBoxRef.value.scrollHeight;
                }
              });
            };

            ws.onclose = () => {
              console.log("WebSocket disconnected. Reconnecting in 3s...");
              setTimeout(initWebSocket, 3000);
            };
          };

          onMounted(() => {
            initWebSocket();
          });

          const submitForm = async () => {
            if (!inputVal.value) {
              ElementPlus.ElMessage.warning("请输入 URL 或 ID");
              return;
            }

            loading.value = true;
            result.value = null;
            error.value = null;
            logs.value = []; // 清空之前的日志

            try {
              const response = await fetch("/api/verify", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ url_or_id: inputVal.value }),
              });

              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.detail || data.message || "请求失败");
              }

              if (data.success) {
                result.value = data;
                ElementPlus.ElMessage.success("验证提交成功");
              } else {
                error.value = data.message || "未知错误";
                ElementPlus.ElMessage.error(error.value);
              }
            } catch (err) {
              error.value = err.message;
              ElementPlus.ElMessage.error(err.message);
            } finally {
              loading.value = false;
            }
          };

          return {
            inputVal,
            loading,
            result,
            error,
            submitForm,
            logs,
            logBoxRef,
          };
        },
      });

      app.use(ElementPlus);
      app.mount("#app");
    </script>
  </body>
</html>
